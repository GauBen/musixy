!function(){var t,e;(e=t||(t={}))[e.YoutubeId=0]="YoutubeId",e[e.X=1]="X",e[e.Y=2]="Y",e[e.Title=3]="Title",e[e.Artist=4]="Artist",e[e.Duration=5]="Duration";const s=async(t,e)=>new Promise((s=>{t.addEventListener(e,(t=>{s(t)}),{once:!0})})),a=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");class i{constructor(t,e){if(t instanceof i||t instanceof Object&&"x"in t&&"y"in t)return this.x=t.x,void(this.y=t.y);this.x=t,this.y=e}static orthographicProjection(t,e,s){const a=new i(e).sub(t).normalize();return new i(a.scale(new i(s).sub(t).dot(a))).add(t)}add(t){return new i(this.x+t.x,this.y+t.y)}sub(t){return new i(this.x-t.x,this.y-t.y)}scale(t){return new i(this.x*t,this.y*t)}rotate(t){return new i(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}len2(){return this.x*this.x+this.y*this.y}len(){return Math.sqrt(this.len2())}dot(t){return t.x*this.x+t.y*this.y}normalize(){const t=this.len();if(t<Number.EPSILON||!t)throw new Error("Division by zero");return new i(this.x/t,this.y/t)}}class n{constructor(t,{x:[e,s],y:[a,i],pixelsPerUnit:n,pixelRatio:r}){this.canvas=t,this.context=t.getContext("2d"),this.fromX=e,this.fromY=a,this.toX=s,this.toY=i,this.resize(n,r),this.clear()}resize(t,e){this.pixelsPerUnit=t,this.pixelRatio=e,this.canvas.width=(this.toX-this.fromX)*t*e,this.canvas.height=(this.toY-this.fromY)*t*e,this.canvas.style.width=(this.toX-this.fromX)*t+"px",this.canvas.style.height=(this.toY-this.fromY)*t+"px",this.context.lineWidth=3*e}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.lineJoin="round",this.context.lineCap="round",this.context.lineWidth=2*this.pixelRatio,this.context.fillStyle="#000",this.context.strokeStyle="#000"}drawArrow(t,e){const s=this.toCanvasVector(t),a=this.toCanvasVector(e),i=this.context,n=a.sub(s).normalize();i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(a.x-10*n.x,a.y-10*n.y),i.stroke(),i.beginPath(),i.moveTo(a.x,a.y);const r=a.add(n.scale(20*this.pixelRatio).rotate(3*Math.PI/4)),o=a.add(n.scale(20*this.pixelRatio).rotate(5*Math.PI/4));i.lineTo(r.x,r.y),i.lineTo(o.x,o.y),i.closePath(),i.fillStyle="#000",i.fill()}drawPolyLine(t,e=null){const s=this.context;let a=this.toCanvasVector(t[0]);s.beginPath(),s.moveTo(a.x,a.y);for(const e of t.slice(1))a=this.toCanvasVector(e),s.lineTo(a.x,a.y);s.strokeStyle=e,s.stroke()}drawPoint(t,e=10,s=null){const a=this.context,i=this.toCanvasVector(t);a.beginPath(),a.arc(i.x,i.y,e*this.pixelRatio,0,7,!1),a.fillStyle="#fff",a.fill(),a.strokeStyle=s,a.lineWidth=e/2.5*this.pixelRatio,a.stroke()}drawCircle(t,e,s=null){const a=this.context,i=e*this.pixelsPerUnit*this.pixelRatio,n=this.toCanvasVector(t);a.beginPath(),a.arc(n.x,n.y,i,0,7,!1),a.fillStyle="#fff",a.fill(),a.strokeStyle=s,a.lineWidth=2,a.stroke()}drawText(t,e,s){const a=this.context,i=5*this.pixelRatio,n=20*this.pixelRatio;a.font=`${n}px "Segoe UI"`;const r=this.toCanvasVector(e),o=a.measureText(t).width;switch(s){case"NE":a.fillText(t,r.x+i,r.y-i);break;case"NW":a.fillText(t,r.x-o-i,r.y-i);break;case"SE":a.fillText(t,r.x+i,r.y+n+i);break;case"SW":a.fillText(t,r.x-o-i,r.y+n+i);break;default:throw new Error("Invalid argument for type Direction")}}toCanvasVector(t){return new i((t.x-this.fromX)*this.pixelsPerUnit*this.pixelRatio,(-t.y-this.fromY)*this.pixelsPerUnit*this.pixelRatio)}fromCanvasPoint(t){return new i(t.x/this.pixelsPerUnit+this.fromX,(this.canvas.height-t.y)/this.pixelsPerUnit+this.fromY)}}const r=["./db.json","./db2.json"],o=e=>new i(e[t.X],e[t.Y]);new class{constructor({board:t,duration:e,tooltip:s,databasePicker:a,loadDatabase:i,databaseUrl:r}){this.musics=[],this.databases=new Map,this.checkedDatabases=new Map,this.eventTarget=new EventTarget,this.$board=t,this.$duration=e,this.$tooltip=s,this.$databasePicker=a,this.marker=new n(t,{x:[-1,1],y:[-1,1],pixelsPerUnit:200,pixelRatio:window.devicePixelRatio}),this.$tooltip.innerHTML=`${this.$duration.value} min`,this.$duration.addEventListener("input",(()=>{this.$tooltip.innerHTML=`${this.$duration.value} min`})),i.addEventListener("submit",(async t=>{t.preventDefault(),await this.addDatabase(r.value),this.eventTarget.dispatchEvent(new CustomEvent("reloadDatabase"))}))}async addDatabase(t){const e=await(await fetch(t)).json();if("object"!=typeof e||!("musixy"in e)||1!==e.musixy)throw new Error("Wrong format");this.databases.set(t,e)}async run(){let t=this.loadDatabase();for(;;){t=(await t)()}}async loadDatabase(){this.state=this.loadDatabase;for(const[t,e]of await Promise.all(r.map((async t=>fetch(t).then((async t=>t.json())).then((e=>[t,e]))))))this.databases.set(t,e);return this.loadedDatabases=new Set([r[0]]),this.axes=this.databases.get(r[0]).axes,this.checkedDatabases.set(this.axes.join("/"),this.loadedDatabases),this.hydrateDatabasePicker(),async()=>this.loadMusics()}hydrateDatabasePicker(){const t=new Map;this.$databasePicker.innerHTML="";for(const[e,s]of this.databases.entries()){const a=s.axes.join("/");t.set(a,[...t.get(a)??[],e])}for(const[e,s]of[...t.values()].entries()){const t=document.createElement("fieldset"),a=this.databases.get(s.values().next().value).axes,i=a.join("/");this.checkedDatabases.set(i,this.checkedDatabases.get(i)??new Set);const n=document.createElement("input");n.type="radio",n.name="group",n.id=`group-${e}`,n.checked=this.axes?this.axes.join("/")===i:0===e;const r=document.createElement("label");r.htmlFor=n.id,r.append(n,`↕ ${a[0]} to ${a[1]}, ↔ ${a[2]} to ${a[3]}`),n.addEventListener("input",(()=>{n.checked&&(this.loadedDatabases=this.checkedDatabases.get(i),this.axes=a,this.eventTarget.dispatchEvent(new CustomEvent("reloadDatabase")))}));const o=document.createElement("legend");o.append(r),t.append(o);for(const[e,a]of s.entries()){const s=document.createElement("p"),n=document.createElement("label"),r=document.createElement("input");r.type="checkbox",r.id=`db-${e}`,n.append(r,a),s.append(n),t.append(s),r.checked=this.checkedDatabases.get(i).has(a),r.addEventListener("input",(()=>{const t=this.checkedDatabases.get(i);r.checked?t.add(a):t.delete(a),this.axes.join("/")===i&&(this.loadedDatabases=t),this.eventTarget.dispatchEvent(new CustomEvent("reloadDatabase"))}))}this.$databasePicker.append(t)}}loadMusics(){this.musics=[];for(const t of this.loadedDatabases)this.musics.push(...this.databases.get(t).musics);return async()=>this.resetApp()}resetApp(){this.drawAxes();return document.querySelector("#playlist").innerHTML='<p class="user-instruction">Click twice on the whiteboard to create a playlist</p>',async()=>this.waitForFirstInput()}async waitForFirstInput(){return this.state=this.waitForFirstInput,Promise.race([(async()=>{const t=await s(this.$board,"click");if(0===this.loadedDatabases.size)return async()=>this.waitForFirstInput();const e=this.marker.fromCanvasPoint({x:t.offsetX,y:t.offsetY});return async()=>this.waitForSecondClick(e)})(),this.awaitReloadEvent()])}async waitForSecondClick(t){const e=e=>{const s=this.marker.fromCanvasPoint({x:e.offsetX,y:e.offsetY});this.drawAxes(),this.drawPathPreview(t,s)};this.$board.addEventListener("mousemove",e);const a=await Promise.race([(async()=>{const e=await s(this.$board,"click"),a=this.marker.fromCanvasPoint({x:e.offsetX,y:e.offsetY});return t.sub(a).len()<=Number.EPSILON?async()=>this.waitForSecondClick(a):async()=>this.makePlaylist(t,a)})(),this.awaitReloadEvent()]);return this.$board.removeEventListener("mousemove",e),a}async awaitReloadEvent(){return await new Promise((t=>{this.eventTarget.addEventListener("reloadDatabase",t,{once:!0})})),this.hydrateDatabasePicker(),async()=>this.loadMusics()}makePlaylist(t,e){this.drawAxes(),this.drawPathPreview(t,e);const s=60*Number(this.$duration.value),a=e.sub(t).len()>=.2?this.makeArrowPlaylist(t,e,s):this.makeCirclePlaylist(t,e,s);return localStorage.setItem("musixy-history",JSON.stringify([a,...JSON.parse(localStorage.getItem("musixy-history")??"[]").slice(0,9)])),async()=>this.displayPlaylist(t,e,a)}makeCirclePlaylist(e,s,a){const i=[];for(const t of this.musics)i.push([e.sub(o(t)).len2(),t]);i.sort(((t,e)=>{const[s]=t,[a]=e;return a-s}));const n=[];for(;a>0&&i.length>0;){const[,e]=i.pop();n.push(e),a-=e[t.Duration]}return n}makeArrowPlaylist(e,s,a){const n=[],r=[];let c=this.musics[0],h=e.sub(o(c)).len2(),l=this.musics[0],d=s.sub(o(l)).len2();for(const t of this.musics){const a=o(t),n=i.orthographicProjection(e,s,a),u=n.sub(a).len2();r.push([u,n,t]),e.sub(a).len2()<h&&(c=t,h=e.sub(a).len2()),s.sub(a).len2()<d&&(l=t,d=s.sub(a).len2())}a-=l===c?c[t.Duration]:c[t.Duration]+l[t.Duration],r.sort(((t,e)=>{const[s]=t,[a]=e;return s-a}));const u=[[s.sub(e).len2(),e,s]];for(;a>0&&u.length>0;){let s=u[0][0],i=u[0],o=0;for(const[t,e]of u.slice(1).entries())e[0]>s&&(i=e,s=e[0],o=t+1);u.splice(o,1);const h=i[1],d=i[2];for(const[s,[,i,o]]of r.entries()){if(o===c||o===l)continue;const y=i.sub(h).dot(d.sub(h))/d.sub(h).len2();if(y<=0||y>=1)continue;r.splice(s,1),n.push([i.sub(e).len2(),o]),a-=o[t.Duration];const p=[i.sub(h).len2(),h,i],m=[d.sub(i).len2(),i,d];u.push(p,m);break}}n.sort(((t,e)=>{const[s]=t,[a]=e;return s-a}));const y=n.map((t=>{const[,e]=t;return e}));return y.unshift(c),c!==l&&y.push(l),y}displayPlaylist(e,s,i){const n=document.querySelector("#playlist");if(0===i.length)return n.innerHTML='<p class="user-instruction"><strong>Error:</strong> the server created an empty playlist. Please retry later.</p>',async()=>this.waitForFirstInput();let r='<div class="wrapper"><ul class="music-list">';for(const e of i)r+=`<li class="item playlist-entry">\n          <img class="cover" src="https://i.ytimg.com/vi/${a(e[0])}/mqdefault.jpg" alt="Thumbnail" width="85.33" height="48">\n          <span class="title">${a(e[t.Title])}</span>\n          <span class="artist">${a(e[t.Artist])}</span>\n        </li>`;return r+="</ul></div>",r+=`<p class="youtube-link"><a href="http://www.youtube.com/watch_videos?video_ids=${encodeURI(i.map((e=>e[t.YoutubeId])).join(","))}" target="_blank" rel="noopener">Listen on YouTube</a></p>`,n.innerHTML=r,async()=>this.drawPlaylist(e,s,i)}async drawPlaylist(t,e,s){return this.state=this.drawPlaylist,Promise.race([new Promise((a=>{const i=s.map((t=>o(t))),n=s=>{const a=[];let n=0,r=i[0];const o=[r];a.push(r);for(const t of i.slice(1)){const e=t.sub(r),i=e.len();if(n+=i,s<n){a.push(r.add(e.scale((s+i-n)/i)));break}o.push(t),a.push(t),r=t}this.drawAxes(),this.drawPathPreview(t,e),this.marker.drawPolyLine(a,"#F00");for(const t of o)this.marker.drawPoint(t,4);return s<n};let r=null;const c=t=>{this.state===this.drawPlaylist&&(null===r&&(r=t),n(.001*(t-r))?requestAnimationFrame(c):a((async()=>this.waitForFirstInput())))};requestAnimationFrame(c)})),this.awaitReloadEvent()])}drawAxes(){this.marker.clear(),this.marker.drawArrow({x:-.98,y:0},{x:.98,y:0}),this.marker.drawArrow({x:0,y:-.98},{x:0,y:.98}),this.marker.drawText(this.axes[0],{x:-.03,y:-1},"NW"),this.marker.drawText(this.axes[1],{x:-.08,y:1},"SW"),this.marker.drawText(this.axes[2],{x:-1,y:0},"SE"),this.marker.drawText(this.axes[3],{x:.9,y:0},"SW")}drawPathPreview(t,e){const s=e.sub(t).len();s>=.2?this.marker.drawArrow(t,e):s>=Number.EPSILON&&this.marker.drawCircle(t,s,"#000")}}({board:document.querySelector("#board"),duration:document.querySelector("#duration"),tooltip:document.querySelector("#duration-tooltip"),databasePicker:document.querySelector("#database-picker"),loadDatabase:document.querySelector("#load-database"),databaseUrl:document.querySelector("#database-url")}).run()}();
//# sourceMappingURL=index.d844bdeb.js.map
