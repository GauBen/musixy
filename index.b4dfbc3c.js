!function(){class t{constructor(s,i){if(s instanceof t||s instanceof Object&&"x"in s&&"y"in s)return this.x=s.x,void(this.y=s.y);this.x=s,this.y=i}static orthographicProjection(s,i,e){const r=new t(i).sub(s).normalize();return new t(r.scale(new t(e).sub(s).dot(r))).add(s)}add(s){return new t(this.x+s.x,this.y+s.y)}sub(s){return new t(this.x-s.x,this.y-s.y)}scale(s){return new t(this.x*s,this.y*s)}rotate(s){return new t(this.x*Math.cos(s)-this.y*Math.sin(s),this.x*Math.sin(s)+this.y*Math.cos(s))}len2(){return this.x*this.x+this.y*this.y}len(){return Math.sqrt(this.len2())}dot(t){return t.x*this.x+t.y*this.y}normalize(){const s=this.len();if(s<Number.EPSILON||!s)throw new Error("Division by zero");return new t(this.x/s,this.y/s)}}class s{constructor(t,{x:[s,i],y:[e,r],width:n,height:o,pixelRatio:a}){this.canvas=t,this.context=t.getContext("2d"),this.fromX=s,this.fromY=e,this.toX=i,this.toY=r,this.resize(n,o,a),this.clear()}resize(t,s,i){this.width=t,this.height=s,this.pixelRatio=i,this.canvas.width=t*i,this.canvas.height=s*i,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${s}px`,this.context.lineWidth=3*i}clear(){this.context.clearRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),this.context.lineJoin="round",this.context.lineCap="round",this.context.lineWidth=2*this.pixelRatio,this.context.fillStyle="#000",this.context.strokeStyle="#000"}drawArrow(t,s){const i=this.toCanvasVector(t),e=this.toCanvasVector(s),r=this.context,n=e.sub(i).normalize();r.beginPath(),r.moveTo(i.x,i.y),r.lineTo(e.x-10*n.x,e.y-10*n.y),r.stroke(),r.beginPath(),r.moveTo(e.x,e.y);const o=e.add(n.scale(20*this.pixelRatio).rotate(3*Math.PI/4)),a=e.add(n.scale(20*this.pixelRatio).rotate(5*Math.PI/4));r.lineTo(o.x,o.y),r.lineTo(a.x,a.y),r.closePath(),r.fillStyle="#000",r.fill()}drawPolyLine(t,s=null){const i=this.context;let e=this.toCanvasVector(t[0]);i.beginPath(),i.moveTo(e.x,e.y);for(const s of t.slice(1))e=this.toCanvasVector(s),i.lineTo(e.x,e.y);i.strokeStyle=s,i.stroke()}drawPoint(t,s=10,i=null){const e=this.context,r=this.toCanvasVector(t);e.beginPath(),e.arc(r.x,r.y,s*this.pixelRatio,0,7,!1),e.fillStyle="#fff",e.fill(),e.strokeStyle=i,e.lineWidth=s/2.5*this.pixelRatio,e.stroke()}drawCircle(t,s,i=null){const e=this.context,r=s/(this.toX-this.fromX)*this.width*this.pixelRatio,n=this.toCanvasVector(t);e.beginPath(),e.arc(n.x,n.y,r,0,7,!1),e.fillStyle="#fff",e.fill(),e.strokeStyle=i,e.lineWidth=2,e.stroke()}drawText(t,s,i){const e=this.context,r=5*this.pixelRatio,n=20*this.pixelRatio;e.font=`${n}px "Segoe UI"`;const o=this.toCanvasVector(s),a=e.measureText(t).width;switch(i){case"NE":e.fillText(t,o.x+r,o.y-r);break;case"NW":e.fillText(t,o.x-a-r,o.y-r);break;case"SE":e.fillText(t,o.x+r,o.y+n+r);break;case"SW":e.fillText(t,o.x-a-r,o.y+n+r);break;default:throw new Error("Invalid argument for type Direction")}}toCanvasVector(s){return new t((s.x-this.fromX)/(this.toX-this.fromX)*this.width*this.pixelRatio,(-s.y-this.fromY)/(this.toY-this.fromY)*this.height*this.pixelRatio)}fromCanvasPoint(s){return new t(s.x/this.width*(this.toX-this.fromX)+this.fromX,(1-s.y/this.height)*(this.toY-this.fromY)+this.fromY)}}const i=async(t,s)=>new Promise((i=>{t.addEventListener(s,(t=>{i(t)}),{once:!0})})),e=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");var r,n;(n=r||(r={}))[n.YoutubeId=0]="YoutubeId",n[n.X=1]="X",n[n.Y=2]="Y",n[n.Title=3]="Title",n[n.Artist=4]="Artist",n[n.Duration=5]="Duration";const o=s=>new t(s[r.X],s[r.Y]);new class{constructor(t){this.board=t,this.marker=new s(t,{x:[-1,1],y:[-1,1],width:400,height:400,pixelRatio:window.devicePixelRatio})}async run(){this.setupSlider(),this.db=await(await fetch("./db.json")).json();for(let t=0;t<1e3;t++)this.db.musics.push(["l0q7MLPo-u8",2*Math.random()-1,2*Math.random()-1,"The Sound of Silence","Simon & Garfunkel",187]);this.init();let t=this.initialState();for(;;){t=(await t)()}}setupSlider(){this.$duration=document.querySelector("#duration");const t=document.querySelector("#duration-tooltip");this.$duration.addEventListener("input",(()=>{t.innerHTML=`${this.$duration.value} min`}))}init(){this.marker.clear(),this.marker.drawArrow({x:-.98,y:0},{x:.98,y:0}),this.marker.drawArrow({x:0,y:-.98},{x:0,y:.98}),this.marker.drawText(this.db.axes[0],{x:-.03,y:-1},"NW"),this.marker.drawText(this.db.axes[1],{x:-.08,y:1},"SW"),this.marker.drawText(this.db.axes[2],{x:-1,y:0},"SE"),this.marker.drawText(this.db.axes[3],{x:.9,y:0},"SW")}async initialState(){const t=await i(this.board,"click"),s=this.marker.fromCanvasPoint({x:t.offsetX,y:t.offsetY});return async()=>this.state2(s)}async state2(t){const s=s=>{const i=this.marker.fromCanvasPoint({x:s.offsetX,y:s.offsetY});this.init();const e=t.sub(i).len();e>=.2?this.marker.drawArrow(t,i):e>=Number.EPSILON&&this.marker.drawCircle(t,e,"#000")};this.board.addEventListener("mousemove",s);const e=await i(this.board,"click"),r=this.marker.fromCanvasPoint({x:e.offsetX,y:e.offsetY});return this.board.removeEventListener("mousemove",s),t.sub(r).len()<=Number.EPSILON?async()=>this.state2(r):async()=>this.fetchPlaylist(t,r)}async fetchPlaylist(t,s){this.init(),this.marker.drawArrow(t,s);const i=60*Number(this.$duration.value),e=s.sub(t).len()>=.2?this.makePathPlaylist(t,s,i):this.makeCirclePlaylist(t,s,i);return async()=>this.displayPlaylist(t,s,e)}makeCirclePlaylist(t,s,i){const e=[];for(const s of this.db.musics)e.push([t.sub(o(s)).len2(),s]);e.sort(((t,s)=>{const[i]=t,[e]=s;return e-i}));const n=[];for(;i>0&&e.length>0;){const[,t]=e.pop();n.push(t),i-=t[r.Duration]}return n}makePathPlaylist(s,i,e){const n=[],a=[];let h=this.db.musics[0],l=s.sub(o(h)).len2(),c=this.db.musics[0],u=i.sub(o(c)).len2();for(const e of this.db.musics){const r=o(e),n=t.orthographicProjection(s,i,r),d=n.sub(r).len2();a.push([d,n,e]),s.sub(r).len2()<l&&(h=e,l=s.sub(r).len2()),i.sub(r).len2()<u&&(c=e,u=i.sub(r).len2())}e-=c===h?h[r.Duration]:h[r.Duration]+c[r.Duration],a.sort(((t,s)=>{const[i]=t,[e]=s;return i-e}));const d=[[i.sub(s).len2(),s,i]];for(;e>0&&d.length>0;){let t=d[0][0],i=d[0],o=0;for(const[s,e]of d.slice(1).entries())e[0]>t&&(i=e,t=e[0],o=s+1);d.splice(o,1);const l=i[1],u=i[2];for(const[t,[,i,o]]of a.entries()){if(o===h||o===c)continue;const y=i.sub(l).dot(u.sub(l))/u.sub(l).len2();if(y<=0||y>=1)continue;a.splice(t,1),n.push([i.sub(s).len2(),o]),e-=o[r.Duration];const x=[i.sub(l).len2(),l,i],m=[u.sub(i).len2(),i,u];d.push(x,m);break}}n.sort(((t,s)=>{const[i]=t,[e]=s;return i-e}));const y=n.map((t=>{const[,s]=t;return s}));return y.unshift(h),h!==c&&y.push(c),y}async displayPlaylist(t,s,i){const n=document.querySelector("#playlist");if(0===i.length)return n.innerHTML='<p class="user-instruction"><strong>Error:</strong> the server created an empty playlist. Please retry later.</p>',async()=>this.initialState();let o='<div class="wrapper"><ul class="music-list">';for(const t of i)o+=`<li class="item playlist-entry">\n          <img class="cover" src="https://i.ytimg.com/vi/${e(t[0])}/mqdefault.jpg" alt="Thumbnail" width="85.33" height="48">\n          <span class="title">${e(t[r.Title])}</span>\n          <span class="artist">${e(t[r.Artist])}</span>\n        </li>`;return o+="</ul></div>",o+=`<p class="youtube-link"><a href="http://www.youtube.com/watch_videos?video_ids=${encodeURI(i.map((t=>t[r.YoutubeId])).join(","))}" target="_blank" rel="noopener">Listen on YouTube</a></p>`,n.innerHTML=o,async()=>this.drawPlaylist(t,s,i)}async drawPlaylist(t,s,i){return new Promise((e=>{const r=i.map((t=>o(t))),n=i=>{const e=[];let n=0,o=r[0];const a=[o];e.push(o);for(const t of r.slice(1)){const s=t.sub(o),r=s.len();if(n+=r,i<n){e.push(o.add(s.scale((i+r-n)/r)));break}a.push(t),e.push(t),o=t}this.init();const h=t.sub(s).len();h>=.2?this.marker.drawArrow(t,s):h>=Number.EPSILON&&this.marker.drawCircle(t,h,"#000"),this.marker.drawPolyLine(e,"#F00");for(const t of a)this.marker.drawPoint(t,4);return i<n};let a=null;const h=t=>{null===a&&(a=t),n(.001*(t-a))?requestAnimationFrame(h):e((async()=>this.initialState()))};requestAnimationFrame(h)}))}}(document.querySelector("#board")).run()}();
//# sourceMappingURL=index.b4dfbc3c.js.map
